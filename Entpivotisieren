Sub UnpivotTable()
    Dim wsSource As Worksheet
    Dim wsTarget As Worksheet
    Dim wsName As String
    Dim lastRow As Long
    Dim lastCol As Long
    Dim i As Long, j As Long
    Dim header As String
    Dim targetRow As Long
    Dim lastChar As String
    Dim data As Variant

    ' Find the worksheet with "spez Projektbudgetplan" in its name
    For Each wsSource In ThisWorkbook.Worksheets
        If InStr(wsSource.Name, "spez Projektbudgetplan") > 0 Then
            ' Determine the last character of the worksheet name
            lastChar = Right(wsSource.Name, 1)
            ' Create a new worksheet name
            wsName = "entpivotisiert" & lastChar
            ' Create a new worksheet for the unpivoted data
            Set wsTarget = ThisWorkbook.Sheets.Add
            wsTarget.Name = wsName

            ' Set headers for the unpivoted table
            wsTarget.Cells(1, 1).Value = "Rolle"
            wsTarget.Cells(1, 2).Value = "Monat"
            wsTarget.Cells(1, 3).Value = "SOLL in STD"

            ' Get the last row and last column
            lastRow = wsSource.Cells(wsSource.Rows.Count, "B").End(xlUp).Row
            lastCol = wsSource.Cells(1, wsSource.Columns.Count).End(xlToLeft).Column

            ' Initialize target row for unpivoted data
            targetRow = 2

            ' Read data into array for faster processing
            data = wsSource.Range(wsSource.Cells(2, 2), wsSource.Cells(lastRow, lastCol)).Value

            ' Loop through the data and unpivot
            For i = 2 To UBound(data, 1)
                For j = 2 To UBound(data, 2)
                    header = wsSource.Cells(1, j + 1).Value
                    If header <> "Total Months" Then
                        wsTarget.Cells(targetRow, 1).Value = data(i, 1) ' Rolle
                        wsTarget.Cells(targetRow, 2).Value = header ' Monat
                        wsTarget.Cells(targetRow, 3).Value = data(i, j) ' SOLL in STD
                        targetRow = targetRow + 1
                    End If
                Next j
            Next i
            Exit For
        End If
    Next wsSource

    MsgBox "Die Tabelle wurde erfolgreich entpivotisiert und in '" & wsName & "' gespeichert.", vbInformation
End Sub
